name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '*.md'
      - 'terraform/**'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '*.md'
      - 'terraform/**'
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Run ESLint
        run: yarn lint
        
      - name: Check TypeScript
        run: yarn typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Configure test environment
        id: test-config
        run: |
          # Check which providers are configured in the project
          # This could come from a config file, .env, or other source
          # For now, we'll read from a variable that can be overridden
          
          # Default enabled providers (can be overridden in repository settings)
          ENABLED_PROVIDERS="${ENABLED_PROVIDERS:-postgres}"
          echo "Using enabled providers: $ENABLED_PROVIDERS"
          
          # Create test config file
          echo "# Generated test configuration" > ./test-config.env
          
          # Parse comma-separated providers
          IFS=',' read -ra PROVIDER_ARRAY <<< "$ENABLED_PROVIDERS"
          for provider in "${PROVIDER_ARRAY[@]}"; do
            case $provider in
              postgres)
                echo "ENABLE_POSTGRES=true" >> ./test-config.env
                echo "POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING_TEST || '' }}" >> ./test-config.env
                ;;
              mongodb)
                echo "ENABLE_MONGODB=true" >> ./test-config.env
                echo "MONGODB_CONNECTION_STRING=${{ secrets.MONGODB_CONNECTION_STRING_TEST || '' }}" >> ./test-config.env
                ;;
              supabase)
                echo "ENABLE_SUPABASE=true" >> ./test-config.env
                echo "SUPABASE_URL=${{ secrets.SUPABASE_URL_TEST || '' }}" >> ./test-config.env
                echo "SUPABASE_API_KEY=${{ secrets.SUPABASE_API_KEY_TEST || '' }}" >> ./test-config.env
                ;;
              cosmosdb)
                echo "ENABLE_COSMOSDB=true" >> ./test-config.env
                echo "COSMOSDB_CONNECTION_STRING=${{ secrets.COSMOSDB_CONNECTION_STRING_TEST || '' }}" >> ./test-config.env
                ;;
              sqlserver)
                echo "ENABLE_SQLSERVER=true" >> ./test-config.env
                echo "SQLSERVER_CONNECTION_STRING=${{ secrets.SQLSERVER_CONNECTION_STRING_TEST || '' }}" >> ./test-config.env
                ;;
              ibmcloud)
                echo "ENABLE_IBM=true" >> ./test-config.env
                echo "IBMCLOUD_CONNECTION_STRING=${{ secrets.IBMCLOUD_CONNECTION_STRING_TEST || '' }}" >> ./test-config.env
                ;;
              firebase)
                echo "ENABLE_FIREBASE=true" >> ./test-config.env
                echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID_TEST || '' }}" >> ./test-config.env
                echo "FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY_TEST || '' }}" >> ./test-config.env
                ;;
              aws-rds)
                echo "ENABLE_AWS_RDS=true" >> ./test-config.env
                echo "AWS_REGION=${{ secrets.AWS_REGION_TEST || '' }}" >> ./test-config.env
                echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID_TEST || '' }}" >> ./test-config.env
                echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY_TEST || '' }}" >> ./test-config.env
                echo "AWS_RDS_CONNECTION_STRING=${{ secrets.AWS_RDS_CONNECTION_STRING_TEST || '' }}" >> ./test-config.env
                ;;
              aws-s3)
                echo "ENABLE_AWS_S3=true" >> ./test-config.env
                echo "AWS_REGION=${{ secrets.AWS_REGION_TEST || '' }}" >> ./test-config.env
                echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID_TEST || '' }}" >> ./test-config.env
                echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY_TEST || '' }}" >> ./test-config.env
                echo "AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME_TEST || '' }}" >> ./test-config.env
                ;;
              *)
                echo "Unknown provider: $provider" >&2
                ;;
            esac
          done
          
          # Output the config for debugging
          echo "Generated test configuration:"
          cat ./test-config.env
        shell: bash
        env:
          ENABLED_PROVIDERS: ${{ vars.ENABLED_PROVIDERS || 'postgres' }}
          
      - name: Run tests
        run: yarn test
        env:
          # Load configuration from the generated file
          DOTENV_CONFIG_PATH: ./test-config.env
          
      - name: Upload test coverage
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN || '' }}
        # If CODECOV_TOKEN is not set, this will upload without a token (works for public repos)

  build-next:
    name: Build Next.js App
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Build Next.js app
        run: yarn workspace next-app build
        env:
          # Feature flags for cloud providers - disable for build
          ENABLE_POSTGRES: false
          ENABLE_MONGODB: false
          ENABLE_SUPABASE: false
          ENABLE_COSMOSDB: false
          ENABLE_SQLSERVER: false
          ENABLE_IBM: false
          ENABLE_FIREBASE: false
          ENABLE_AWS_RDS: false
          ENABLE_AWS_S3: false
          
      - name: Upload Next.js build artifact
        uses: actions/upload-artifact@v3
        with:
          name: next-app-build
          path: apps/next/.next
          retention-days: 7

  build-expo:
    name: Build Expo App
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          
      - name: Build Expo app preview
        run: yarn workspace expo-app prebuild
        env:
          # Feature flags for cloud providers - disable for build
          EXPO_PUBLIC_ENABLE_POSTGRES: false
          EXPO_PUBLIC_ENABLE_MONGODB: false
          EXPO_PUBLIC_ENABLE_SUPABASE: false
          EXPO_PUBLIC_ENABLE_COSMOSDB: false
          EXPO_PUBLIC_ENABLE_SQLSERVER: false
          EXPO_PUBLIC_ENABLE_IBM: false
          EXPO_PUBLIC_ENABLE_FIREBASE: false
          EXPO_PUBLIC_ENABLE_AWS_RDS: false
          EXPO_PUBLIC_ENABLE_AWS_S3: false
