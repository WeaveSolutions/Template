rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================================================================
    // AUTH0 INTEGRATION RULES
    // ===========================================================================
    // These rules validate Auth0 JWT custom claims instead of Firebase Auth
    // Custom tokens are generated by CRA service from Auth0 JWTs
    
    // Helper functions for Auth0 token validation
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserId() {
      return request.auth.uid;
    }
    
    function hasAuth0Claim(claim) {
      return request.auth.token != null && 
             request.auth.token.get(claim, null) != null;
    }
    
    function getAuth0Claim(claim) {
      return request.auth.token.get(claim, null);
    }
    
    function hasPermission(permission) {
      let permissions = getAuth0Claim('permissions');
      return permissions != null && permission in permissions;
    }
    
    function getUserRank() {
      return getAuth0Claim('rank');
    }
    
    function getOrgId() {
      return getAuth0Claim('org_id');
    }
    
    // ===========================================================================
    // USER PROFILES COLLECTION
    // ===========================================================================
    match /user_profiles/{userId} {
      // Users can read/write their own profile
      allow read, write: if isAuthenticated() && 
                           getUserId() == userId &&
                           hasAuth0Claim('cra_user_id');
      
      // Admins can read all profiles
      allow read: if isAuthenticated() && 
                    hasPermission('read:all_profiles') &&
                    getUserRank() in ['admin', 'moderator'];
    }
    
    // ===========================================================================
    // ORGANIZATIONS COLLECTION
    // ===========================================================================
    match /organizations/{orgId} {
      // Members can read their organization
      allow read: if isAuthenticated() && 
                    getOrgId() == orgId &&
                    hasAuth0Claim('org_id');
      
      // Org admins can write to their organization
      allow write: if isAuthenticated() && 
                     getOrgId() == orgId &&
                     hasPermission('write:organization');
    }
    
    // ===========================================================================
    // POSTS COLLECTION
    // ===========================================================================
    match /posts/{postId} {
      // Anyone can read published posts
      allow read: if resource.data.published == true;
      
      // Authenticated users can read all posts
      allow read: if isAuthenticated();
      
      // Users can create posts if authenticated
      allow create: if isAuthenticated() && 
                      hasPermission('write:posts') &&
                      request.resource.data.author_id == getUserId();
      
      // Users can update their own posts
      allow update: if isAuthenticated() && 
                      resource.data.author_id == getUserId() &&
                      hasPermission('write:posts');
      
      // Admins can delete any post
      allow delete: if isAuthenticated() && 
                      (resource.data.author_id == getUserId() || 
                       hasPermission('delete:posts'));
    }
    
    // ===========================================================================
    // COMMENTS COLLECTION
    // ===========================================================================
    match /posts/{postId}/comments/{commentId} {
      // Anyone can read comments on published posts
      allow read: if get(/databases/$(database)/documents/posts/$(postId)).data.published == true;
      
      // Authenticated users can read all comments
      allow read: if isAuthenticated();
      
      // Authenticated users can create comments
      allow create: if isAuthenticated() && 
                      hasPermission('write:comments') &&
                      request.resource.data.author_id == getUserId();
      
      // Users can update their own comments
      allow update: if isAuthenticated() && 
                      resource.data.author_id == getUserId();
      
      // Users can delete their own comments, moderators can delete any
      allow delete: if isAuthenticated() && 
                      (resource.data.author_id == getUserId() || 
                       getUserRank() in ['admin', 'moderator']);
    }
    
    // ===========================================================================
    // ADMIN COLLECTIONS
    // ===========================================================================
    match /admin/{document=**} {
      // Only authenticated admins can access admin collections
      allow read, write: if isAuthenticated() && 
                           getUserRank() == 'admin' &&
                           hasPermission('admin:access');
    }
    
    // ===========================================================================
    // ANALYTICS COLLECTION
    // ===========================================================================
    match /analytics/{document=**} {
      // Service accounts can write analytics
      allow write: if hasAuth0Claim('service_account') &&
                     getAuth0Claim('service_account') == true;
      
      // Admins can read analytics
      allow read: if isAuthenticated() && 
                    getUserRank() in ['admin', 'moderator'] &&
                    hasPermission('read:analytics');
    }
    
    // ===========================================================================
    // DEFAULT DENY RULE
    // ===========================================================================
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
