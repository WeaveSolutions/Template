rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ===========================================================================
    // AUTH0 INTEGRATION RULES
    // ===========================================================================
    // These rules validate Auth0 JWT custom claims instead of Firebase Auth
    // Custom tokens are generated by CRA service from Auth0 JWTs
    
    // Helper functions for Auth0 token validation
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserId() {
      return request.auth.uid;
    }
    
    function hasAuth0Claim(claim) {
      return request.auth.token != null && 
             request.auth.token.get(claim, null) != null;
    }
    
    function getAuth0Claim(claim) {
      return request.auth.token.get(claim, null);
    }
    
    function hasPermission(permission) {
      let permissions = getAuth0Claim('permissions');
      return permissions != null && permission in permissions;
    }
    
    function getUserRank() {
      return getAuth0Claim('rank');
    }
    
    function getOrgId() {
      return getAuth0Claim('org_id');
    }
    
    function isValidImageType() {
      return resource.contentType.matches('image/.*');
    }
    
    function isValidDocumentType() {
      return resource.contentType.matches('application/pdf') ||
             resource.contentType.matches('application/msword') ||
             resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
             resource.contentType.matches('text/plain');
    }
    
    function isValidFileSize() {
      return resource.size < 10 * 1024 * 1024; // 10MB limit
    }
    
    // ===========================================================================
    // USER UPLOADS
    // ===========================================================================
    match /users/{userId}/{allPaths=**} {
      // Users can manage their own files
      allow read, write: if isAuthenticated() && 
                           getUserId() == userId &&
                           hasAuth0Claim('cra_user_id') &&
                           isValidFileSize();
      
      // Admins can read all user files
      allow read: if isAuthenticated() && 
                    hasPermission('read:all_files') &&
                    getUserRank() in ['admin', 'moderator'];
    }
    
    // ===========================================================================
    // PROFILE PICTURES
    // ===========================================================================
    match /profile_pictures/{userId} {
      // Users can read/write their own profile picture
      allow read, write: if isAuthenticated() && 
                           getUserId() == userId &&
                           isValidImageType() &&
                           resource.size < 5 * 1024 * 1024; // 5MB limit for profile pics
      
      // Anyone can read profile pictures for public display
      allow read: if true;
    }
    
    // ===========================================================================
    // ORGANIZATION FILES
    // ===========================================================================
    match /organizations/{orgId}/{allPaths=**} {
      // Organization members can read files
      allow read: if isAuthenticated() && 
                    getOrgId() == orgId &&
                    hasAuth0Claim('org_id');
      
      // Organization admins can write files
      allow write: if isAuthenticated() && 
                     getOrgId() == orgId &&
                     hasPermission('write:org_files') &&
                     isValidFileSize();
    }
    
    // ===========================================================================
    // PUBLIC ASSETS
    // ===========================================================================
    match /public/{allPaths=**} {
      // Anyone can read public assets
      allow read: if true;
      
      // Only admins can write public assets
      allow write: if isAuthenticated() && 
                     getUserRank() == 'admin' &&
                     hasPermission('write:public_assets') &&
                     isValidFileSize();
    }
    
    // ===========================================================================
    // POST ATTACHMENTS
    // ===========================================================================
    match /posts/{postId}/attachments/{fileName} {
      // Anyone can read attachments for published posts
      allow read: if true;
      
      // Authenticated users can upload attachments
      allow write: if isAuthenticated() && 
                     hasPermission('write:post_attachments') &&
                     (isValidImageType() || isValidDocumentType()) &&
                     isValidFileSize();
    }
    
    // ===========================================================================
    // TEMPORARY UPLOADS
    // ===========================================================================
    match /temp/{userId}/{fileName} {
      // Users can manage temporary files (24-hour lifecycle)
      allow read, write, delete: if isAuthenticated() && 
                                   getUserId() == userId &&
                                   isValidFileSize();
    }
    
    // ===========================================================================
    // ADMIN FILES
    // ===========================================================================
    match /admin/{allPaths=**} {
      // Only authenticated admins can access admin files
      allow read, write: if isAuthenticated() && 
                           getUserRank() == 'admin' &&
                           hasPermission('admin:files');
    }
    
    // ===========================================================================
    // BACKUP FILES
    // ===========================================================================
    match /backups/{allPaths=**} {
      // Service accounts can write backups
      allow write: if hasAuth0Claim('service_account') &&
                     getAuth0Claim('service_account') == true;
      
      // Admins can read backups
      allow read: if isAuthenticated() && 
                    getUserRank() == 'admin' &&
                    hasPermission('read:backups');
    }
    
    // ===========================================================================
    // DEFAULT DENY RULE
    // ===========================================================================
    // Deny all other access by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
