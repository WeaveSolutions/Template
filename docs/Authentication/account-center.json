{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cra.example.com/schemas/account-center-v3.json",
  "title": "CRA Account Center Schema",
  "description": "Enhanced schema for Central Rank Authority with arrays for efficiency, event detection, and regulatory compliance",
  "type": "object",
  "properties": {
    "root_id": {
      "type": "string",
      "pattern": "^auth0\\|[a-zA-Z0-9]+$",
      "description": "Auth0 user ID as root identity"
    },
    "cra_version": {
      "type": "string",
      "default": "3.0.0",
      "description": "Schema version for backward compatibility and upgrades"
    },
    "primary_email": {
      "type": "string",
      "format": "email",
      "description": "Primary verified email address"
    },
    "pending_email_change": {
      "type": ["object", "null"],
      "properties": {
        "new_email": { "type": "string", "format": "email" },
        "verification_code_hash": { "type": "string" },
        "expires_at": { "type": "string", "format": "date-time" },
        "attempts": { "type": "integer", "minimum": 0, "default": 0 }
      },
      "required": ["new_email", "verification_code_hash", "expires_at"]
    },
    "display_name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 50,
      "description": "User's preferred display name"
    },
    "connected_providers": {
      "type": "array",
      "description": "Array of OAuth providers for simpler querying/serialization (replaces linked list)",
      "items": {
        "type": "object",
        "properties": {
          "provider": {
            "type": "string",
            "enum": ["google-oauth2", "apple", "facebook", "microsoft", "x-twitter", "discord", "github", "linkedin", "amazon", "spotify", "slack", "reddit", "coderabbit"]
          },
          "provider_user_id": { "type": "string" },
          "display_name": { "type": "string" },
          "email": { "type": "string", "format": "email" },
          "scopes": { "type": "array", "items": { "type": "string" } },
          "token_data": {
            "type": "object",
            "properties": {
              "vault_reference": { "type": "string" },
              "expires_at": { "type": "string", "format": "date-time" },
              "scope_granted": { "type": "array", "items": { "type": "string" } }
            },
            "required": ["vault_reference", "expires_at"]
          },
          "status": { "type": "string", "enum": ["active", "disconnected", "suspended", "error"], "default": "active" },
          "connected_at": { "type": "string", "format": "date-time" },
          "last_sync": { "type": "string", "format": "date-time" },
          "data_retention_choice": { "type": "string", "enum": ["keep", "delete"] },
          "error_count": { "type": "integer", "default": 0 },
          "last_error": {
            "type": ["object", "null"],
            "properties": {
              "message": { "type": "string" },
              "timestamp": { "type": "string", "format": "date-time" },
              "type": { "type": "string" }
            }
          },
          "origin_signature": { "type": "string", "description": "HMAC-SHA256 for tamper detection" }
        },
        "required": ["provider", "provider_user_id", "status", "connected_at", "data_retention_choice", "origin_signature"]
      }
    },
    "data_objects": {
      "type": "array",
      "description": "Array of data objects with origin tracking",
      "items": {
        "type": "object",
        "properties": {
          "object_id": { "type": "string" },
          "object_type": { "type": "string" },
          "data_reference": {
            "type": "object",
            "properties": {
              "storage_type": { "type": "string", "enum": ["inline", "external", "encrypted"] },
              "storage_key": { "type": "string" },
              "size_bytes": { "type": "integer", "minimum": 0 },
              "encryption_method": { "type": "string", "enum": ["aes-256-gcm", "none"] }
            }
          },
          "origin": {
            "type": "object",
            "properties": {
              "provider": { "type": "string" },
              "provider_user_id": { "type": "string" },
              "source_type": { "type": "string" },
              "imported_at": { "type": "string", "format": "date-time" },
              "last_updated": { "type": "string", "format": "date-time" },
              "retention_policy": { "type": "string", "enum": ["keep", "delete"] },
              "sync_enabled": { "type": "boolean", "default": true },
              "quality_score": { "type": "number", "minimum": 0, "maximum": 1 },
              "trust_level": { "type": "string", "enum": ["verified", "unverified", "suspicious"] },
              "integrity_hash": { "type": "string" }
            },
            "required": ["provider", "source_type", "imported_at", "retention_policy", "integrity_hash"]
          },
          "access_log": {
            "type": "array",
            "description": "Array of access events (replaces linked list)",
            "items": {
              "type": "object",
              "properties": {
                "action": { "type": "string" },
                "timestamp": { "type": "string", "format": "date-time" },
                "source": { "type": "string" },
                "ip_address": { "type": "string", "pattern": "^((([0-9]{1,3}\\.){3}[0-9]{1,3})|([0-9a-fA-F:]+))$" },
                "user_agent": { "type": "string" }
              },
              "required": ["action", "timestamp", "source"]
            }
          }
        },
        "required": ["object_id", "object_type", "origin"]
      }
    },
    "passkeys": {
      "type": "array",
      "description": "Array of WebAuthn passkeys",
      "items": {
        "type": "object",
        "properties": {
          "credential_id": { "type": "string" },
          "public_key": { "type": "string" },
          "device_info": {
            "type": "object",
            "properties": {
              "name": { "type": "string" },
              "type": { "type": "string", "enum": ["phone", "laptop", "desktop", "tablet", "security_key"] }
            }
          },
          "created_at": { "type": "string", "format": "date-time" },
          "last_used": { "type": "string", "format": "date-time" }
        },
        "required": ["credential_id", "public_key", "created_at"]
      }
    },
    "user_preferences": {
      "type": "object",
      "properties": {
        "default_retention_policy": { "type": "string", "enum": ["keep", "delete"] },
        "mfa_enabled": { "type": "boolean", "default": false },
        "preferred_mfa_method": { "type": "string", "enum": ["sms", "totp", "webauthn", "none"] },
        "notifications": {
          "type": "object",
          "properties": {
            "email_alerts": { "type": "boolean", "default": true },
            "security_notifications": { "type": "boolean", "default": true },
            "provider_sync_notifications": { "type": "boolean", "default": false }
          }
        },
        "privacy": {
          "type": "object",
          "properties": {
            "data_sharing_consent": {
              "type": "object",
              "properties": {
                "global_opt_out": { "type": "boolean", "default": false },
                "per_category": {
                  "type": "object",
                  "properties": {
                    "profile": { "type": "boolean", "default": true },
                    "analytics": { "type": "boolean", "default": true },
                    "marketing": { "type": "boolean", "default": false }
                  }
                },
                "consent_timestamp": { "type": "string", "format": "date-time", "description": "When consent was last updated" }
              }
            },
            "analytics_enabled": { "type": "boolean", "default": true },
            "gdpr_consent_given": { "type": "boolean" },
            "gdpr_consent_date": { "type": "string", "format": "date-time" }
          }
        }
      }
    },
    "system_metadata": {
      "type": "object",
      "properties": {
        "roles": { "type": "array", "items": { "type": "string" } },
        "permissions": { "type": "array", "items": { "type": "string" } },
        "subscription": {
          "type": "object",
          "properties": {
            "plan": { "type": "string", "enum": ["free", "premium", "enterprise"] },
            "status": { "type": "string", "enum": ["active", "cancelled", "past_due"] },
            "features_enabled": { "type": "array", "items": { "type": "string" } }
          }
        },
        "security": {
          "type": "object",
          "properties": {
            "risk_score": { "type": "number", "minimum": 0, "maximum": 1 },
            "failed_login_attempts": { "type": "integer", "default": 0 },
            "account_locked": { "type": "boolean", "default": false },
            "last_security_audit": { "type": "string", "format": "date-time" },
            "account_recovery_challenge": {
              "type": ["object", "null"],
              "properties": {
                "challenge_id": { "type": "string" },
                "questions": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "question_text": { "type": "string" },
                      "options_hash": { "type": "string" },
                      "answer_hash": { "type": "string" }
                    },
                    "required": ["question_text", "options_hash", "answer_hash"]
                  }
                },
                "expires_at": { "type": "string", "format": "date-time" },
                "attempts": { "type": "integer", "default": 0 }
              },
              "required": ["challenge_id", "questions", "expires_at"]
            }
          }
        }
      }
    },
    "audit_trail": {
      "type": "array",
      "description": "Append-only audit log array with retention policy",
      "items": {
        "type": "object",
        "properties": {
          "event_type": { "type": "string" },
          "timestamp": { "type": "string", "format": "date-time" },
          "details": { "type": "object" },
          "actor": { "type": "string" }
        },
        "required": ["event_type", "timestamp"]
      }
    },
    "changelog": {
      "type": "array",
      "description": "Event change detection: Array of changes for diffing/detection",
      "items": {
        "type": "object",
        "properties": {
          "change_type": { "type": "string", "enum": ["create", "update", "delete"] },
          "field": { "type": "string" },
          "old_value": { "type": ["string", "object", "null"] },
          "new_value": { "type": ["string", "object", "null"] },
          "timestamp": { "type": "string", "format": "date-time" }
        },
        "required": ["change_type", "field", "timestamp"]
      }
    },
    "created_at": { "type": "string", "format": "date-time" },
    "updated_at": { "type": "string", "format": "date-time" },
    "last_login": { "type": "string", "format": "date-time" },
    "schema_integrity": {
      "type": "object",
      "properties": {
        "checksum": { "type": "string", "description": "SHA-256 of record" },
        "last_verified": { "type": "string", "format": "date-time" },
        "signature": { "type": "string" },
        "encryption": {
          "type": ["object", "null"],
          "properties": {
            "algorithm": { "type": "string", "enum": ["AES-256-GCM"], "default": "AES-256-GCM" },
            "iv": { "type": "string" },
            "auth_tag": { "type": "string" }
          },
          "required": ["algorithm", "iv", "auth_tag"]
        }
      },
      "required": ["checksum", "last_verified"]
    }
  },
  "required": ["root_id", "cra_version", "primary_email", "connected_providers", "data_objects", "passkeys", "user_preferences", "created_at", "updated_at", "schema_integrity"],
  "additionalProperties": true
}